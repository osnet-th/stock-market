# CLAUDE.md

이 파일은 Claude Code (claude.ai/code)가 이 프로젝트의 코드를 작업할 때 참고할 가이드를 제공합니다.

---

# 📋 Section 1: 프로젝트 정보

프로젝트 전체 계획 및 구현 상세 내용은 **[STOCK-MARKET-PROJECT.md](STOCK-MARKET-PROJECT.md)** 문서를 참고하세요.

주요 내용:
- 프로젝트 개요 및 목표
- 기능 요구사항 (인증, 주식 조회, 뉴스 조회, 커뮤니티, 관심/즐겨찾기)
- 사용 가능한 무료 API 목록
- 제약 사항 및 주의 사항
- 데이터베이스 스키마
- 기술 스택

프로젝트 의존성 정보는 **[DEPENDENCIES.md](DEPENDENCIES.md)** 문서를 참고하세요.

주요 내용:
- Spring Framework 의존성 목록 및 버전
- Database 드라이버
- QueryDSL 설정
- JWT 라이브러리
- 테스트 의존성

# 🏗️ Section 2: 아키텍처 및 인프라

아키텍처 설계 상세 내용은 **[ARCHITECTURE.md](ARCHITECTURE.md)** 문서를 참고하세요.
설계 내용이 추가되면 **[ARCHITECTURE.md](ARCHITECTURE.md)** 문서를 업데이트 합니다.

주요 내용:
- 계층 구조 (DDD 스타일)
- 도메인 모델 식별
- 패키지 구조 (도메인별 분리)
- 레이어별 책임 정의
- 주요 설계 원칙 (Entity 연관관계 금지, ID 기반 참조, N+1 문제 해결 등)
# 💻 Section 3: 개발 가이드

## 컨트 벡의 증강 코딩 원칙

- **증강 코딩 vs. 바이브 코딩**: 코드 품질, 테스트, 단순성을 중시하되 AI와 협업
- **증강 개발 관찰**: AI가 반복 동작, 요청하지 않은 기능 구현, 테스트 삭제 등의 신호를 보이면 즉시 개입
- **핵심 주도권 유지**: AI가 너무 앞서가지 않도록 개발자가 설계 방향 제시

---

## 코드 작성 가이드

### 기본 원칙

1. 본 프로젝트는 **DDD 스타일을 적용한 계층형 구조**를 따릅니다.
2. JPA의 Entity는 **연관관계를 사용하지 않으며**, ID 기반 참조만 허용합니다.
3. 기능 구현 시 반드시 **TDD(Test-Driven Development)** 방식으로 작성합니다.
    - 구현체(Impl)를 먼저 작성하지 않습니다.
    - 외부 의존 관계는 Mock을 사용하되, **domain 계층에는 외부 의존이 존재해서는 안 됩니다.**
    - Mock은 **테스트 대상의 경계(boundary)에서만 사용**합니다.
    - 항상 **테스트 실패 → 최소 구현 → 테스트 성공** 순서를 따릅니다.
    - 테스트 코드 작성 이전에 구현 코드를 생성하는 것을 **금지합니다**.
    - 테스트를 통과시키는 **최소 구현만 우선 작성**하고, 이후 리팩토링합니다.
    - 인프라계층(외부 API 호츌, Database CRUD 구현 코드 등)은 TDD 를 적용하지 않습니다.
4. 비즈니스 로직은 **행위(Behavior) 중심**으로 모델링합니다.
    - 도메인 객체는 상태만 담는 형태(Anemic Model)를 지양하고, **도메인 메서드로 규칙/행위를 표현**합니다.
    - `if/else` 중심의 절차적 로직이 application에 과도하게 몰리지 않도록, 핵심 규칙은 domain으로 이동합니다.
5. 요청받지 않은 대규모 리팩토링/포맷팅/공개 API 변경 금지합니다.
6. 구조 변경 또는 기존 코드 변경 시 허락을 받은 후 진행합니다.
7. 모든 요청에 대하여 파일 수정 및 생성은 허락을 받은 후 진행합니다.
8. 코드 설계 요청 시 구조만 설계하여 프로젝트 내의 .claude/designs 내의 .md 파일로 생성합니다.
9. 작업 계획서 작성 시 하나의 파일로 전부 작성하지 않고 단계별로 나눠서 작성합니다.
    - 파일 생성 시 임의로 생성하지 않고 질문 후에 응답 받은 이름으로 생성합니다.
    - 별도 확장자를 지시하지 않는 경우 작업 계획서의 기본 확장자는 .md 입니다.

### 작업 계획 수립

7.  **작업 계획을 작성 가이드**
- 구두 설명인 경우, Claude가 설명을 바탕으로 **md 확장자 파일로 초안 작성** (작업 목표, 수정 범위, 대상 파일, 제약 사항 포함)
    - 작업 계획서는 순서별로 숫자를 부여하지 않습니다.
    - 모든 파일명은 영어로 작성합니다.
    - 작업 계획이 완료된 후 코드 구현 요청 시 해당 작업 계획서와 [ARCHITECTURE.md](ARCHITECTURE.md) 를 기반으로 코드를 작성합니다.

### Entity 작성

8. JPA의 Entity 작성 또는 변경이 필요한 경우, 바로 작성하지 않고 **사전 승인 또는 설계 합의 후 진행합니다.**

### 커뮤니케이션

9. 질문을 응답할 때는 항상 태형님이라는 말을 붙여야 합니다.

---

## 아키텍처 및 계층 규칙

본 프로젝트의 패키지 구조, 레이어 책임, 의존성 방향, DTO/Entity 경계, 트랜잭션 규칙은
**[ARCHITECTURE.md](ARCHITECTURE.md) 파일의 기준을 반드시 따릅니다.**

- 레이어 책임 및 의존성 방향 규칙
- DTO / Entity / Domain 경계 규칙
- 트랜잭션 경계 규칙
- 예외 처리 및 외부 연동 규칙

구조 변경 또는 계층 규칙 위반 가능성이 있는 작업은
**[ARCHITECTURE.md](ARCHITECTURE.md)를 우선 참고하고, 명시적 요청 없이는 구조를 변경하지 않습니다.**

---

## 테스트 코드 가이드

### 테스트 작성 원칙

- 본 프로젝트는 현재 테스트가 부족한 상태입니다.
- **앞으로의 모든 코드 변경 및 추가는 반드시 테스트를 먼저 작성합니다.**
- 테스트 없이 구현 코드를 먼저 작성하는 것을 금지합니다.
- **테스트는 단위테스트(Unit Test)로 범위를 제한합니다.**
    - 통합테스트(Integration Test)나 E2E 테스트는 작성하지 않습니다.
    - 외부 의존성(DB, 외부 API 등)은 Mock으로 대체합니다.
    - 각 클래스/메서드의 동작을 독립적으로 검증합니다.

### TDD 개발 순서

1. **테스트 실패**: 실패하는 테스트를 먼저 작성
2. **최소 구현**: 테스트를 통과시키는 최소한의 코드만 작성
3. **테스트 성공**: 테스트가 통과하는지 확인
4. **리팩토링**: 코드 개선 (테스트는 계속 통과해야 함)

### 테스트 작성 스타일

- 테스트는 **비즈니스 동작과 규칙 중심**으로 작성합니다.
- Given / When / Then 스타일을 권장합니다.
- 기존 아키텍처, 계층 규칙, 코딩 스타일을 반드시 유지합니다.
- 명시적 요청 없이는 public API 변경 또는 신규 API 추가를 하지 않습니다.

---

## 성능 최적화 가이드

### 1. 데이터베이스 쿼리 최적화

- JPA는 연관관계를 사용하지 않으므로, 필요시 명시적 배치 조회 사용
- MyBatis 사용 시 resultMap 적절히 활용하여 불필요한 데이터 조회 지양
- 대량 데이터 조회 시 페이징 필수 (Limit/Offset 또는 Cursor 기반)
- 배치 작업은 JPA batch_size=1000 설정 활용

### 2. 캐싱 전략

- Caffeine 캐시 적극 활용 (특히 자주 조회되는 메타데이터, 설정 정보)
- 캐시 TTL을 데이터 특성에 맞게 설정 (예: Tableau 자격 증명 4시간)
- 데이터 변경 시 명시적 캐시 무효화(invalidation) 처리

### 3. 비동기 처리

- 시간이 오래 걸리는 작업(외부 API 호출, 대량 데이터 처리)은 비동기로 처리
- ThreadPoolTaskExecutor 설정 확인 (코어/최대 스레드 수, 큐 용량)
- 비동기 작업 실패 시 재시도 전략 고려 (Spring Retry 활용)

### 4. API 응답 최적화

- DTO 변환 시 필요한 필드만 포함 (불필요한 데이터 전송 지양)
- 대용량 응답은 스트리밍 또는 페이징 처리
- RestTemplate 타임아웃 설정 준수 (연결 3초, 읽기 5초)

### 5. 연결 풀 관리

- HikariCP 최대 연결 수(10) 초과하지 않도록 주의
- 커넥션 누수 방지 (try-with-resources, @Transactional 적절히 사용)
- DBCP 모니터링 (Operation 모듈 활용)

### 6. 로깅 최적화

- 운영 환경에서는 불필요한 verbose 로그 지양
- 대용량 데이터 로깅 시 요약 정보만 기록
- 로그 레벨 적절히 설정 (INFO/WARN/ERROR)

## CIRITICAL
- 반드시 git과 관련된 모든 행동은 바로 실행하지 않고 어떤 동작인지 설명 후 승인하에 실행한다.
- 새로 작성한 코드와 작업 계획서 등은 새로 생성한 파일인 경우에만 git add 하여 staging area에 추가한다.
- md 파일 작성 시 별도 요청이 없는 한 코드 내용은 작성하지 않는다.
- 작성일만 명시하고 작성자는 명시하지 않는다.
- 내용 중 데이터베이스 스키마는 작성하지 않는다.
- 작업 리스트 중 완료된 작업은 [완료] 로 변경한다.
- 작업 계획서는 숨김폴더인 ./claude/plans, 설계는 ./claude/designs, 분석은 ./claude/analyzes 에 파일을 저장합니다.
  - 파일 제목은 prefix로 "codex-" 를 반드시 붙입니다. 